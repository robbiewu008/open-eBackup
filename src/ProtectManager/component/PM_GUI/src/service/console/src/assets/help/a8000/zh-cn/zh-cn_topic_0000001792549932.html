
<!DOCTYPE html
  PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html lang="zh-cn" xml:lang="zh-cn">
<head>
      <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
   
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="DC.Type" content="topic">
<meta name="DC.Title" content="将代理主机加入华为分布式存储OceanStor Pacific（适用于华为云Stack）">
<meta name="DC.Format" content="XHTML">
<meta name="DC.Identifier" content="ZH-CN_TOPIC_0000001792549932">
<meta name="DC.Language" content="zh-cn">
<link rel="stylesheet" type="text/css" href="public_sys-resources/commonltr.css">
<title>将代理主机加入华为分布式存储OceanStor Pacific（适用于华为云Stack）</title>
</head>
<body style="clear:both; padding-left:10px; padding-top:5px; padding-right:5px; padding-bottom:5px"><a name="ZH-CN_TOPIC_0000001792549932"></a><a name="ZH-CN_TOPIC_0000001792549932"></a>

<h1 class="topictitle1">将代理主机加入华为分布式存储OceanStor Pacific（适用于华为云Stack）</h1>
<div><p>当华为云Stack的存储资源为华为分布式块存储OceanStor Pacific，且配置了反向代理时，请参考本节配置，将代理主机作为VBS客户端接入华为分布式存储，并替换证书，确保代理主机能够访问华为分布式块存储。</p>
<div class="section"><h4 class="sectiontitle">安装VBS</h4><p id="ZH-CN_TOPIC_0000001792549932__zh-cn_topic_0000001792549972_p04301219055">安装VBS服务的详细操作，请参见存储设备对应版本的《产品文档》中的“分配存储空间（SCSI协议-Linux）&gt; 在计算节点上创建VBS”章节。计算节点，即为代理主机。其中部分配置参数说明如下，其余参数请按文档要求填写。</p>
<ul id="ZH-CN_TOPIC_0000001792549932__zh-cn_topic_0000001792549972_ul996111581773"><li id="ZH-CN_TOPIC_0000001792549932__zh-cn_topic_0000001792549972_li1096110589719">管理IP地址：代理主机管理IP地址</li><li id="ZH-CN_TOPIC_0000001792549932__zh-cn_topic_0000001792549972_li149611258279">机柜：代理主机所在机柜【任意值】</li><li id="ZH-CN_TOPIC_0000001792549932__zh-cn_topic_0000001792549972_li49619581879">节点角色：计算</li><li id="ZH-CN_TOPIC_0000001792549932__zh-cn_topic_0000001792549972_li119612582075">安装模式：常规安装</li></ul>
</div>
<div class="section"><h4 class="sectiontitle">替换OceanStor Pacific证书</h4><ol><li id="ZH-CN_TOPIC_0000001792549932__li116039278213"><a name="ZH-CN_TOPIC_0000001792549932__li116039278213"></a><a name="li116039278213"></a><span>登录技术支持网站，获取华为云Stack使用的OceanStor Pacific的API包。</span><p><div class="p" id="ZH-CN_TOPIC_0000001792549932__p560372712219">API包获取路径如下：<ul id="ZH-CN_TOPIC_0000001792549932__ul46031271529"><li id="ZH-CN_TOPIC_0000001792549932__li2060382719212">企业网：<a href="https://support.huawei.com/enterprise/zh/distributed-storage/oceanstor-pacific-9520-pid-251711061/software" target="_blank" rel="noopener noreferrer">点此进入</a></li><li id="ZH-CN_TOPIC_0000001792549932__li5603102711218">运营商网站：<a href="https://support.huawei.com/carrier/productNewOffering?col=product&amp;path=PBI1-21430725/PBI1-251363742/PBI1-21431663/PBI1-251366323/PBI1-251711061&amp;resTab=SW" target="_blank" rel="noopener noreferrer">点此进入</a></li></ul>
</div>
<p id="ZH-CN_TOPIC_0000001792549932__p142401833143418">API包名称为“OceanStor-Pacific_<em id="ZH-CN_TOPIC_0000001792549932__i850443125714">xxx</em>_API.tar.gz”，如OceanStor-Pacific_8.1.2_API.tar.gz。</p>
<div class="p" id="ZH-CN_TOPIC_0000001792549932__p5603927626"><em id="ZH-CN_TOPIC_0000001792549932__i2815510563">xxx</em>表示产品版本号。不同版本的软件包名称中的API大小写略有差异。<div class="note" id="ZH-CN_TOPIC_0000001792549932__note15603527525"><img src="public_sys-resources/note_3.0-zh-cn.png"><span class="notetitle"> </span><div class="notebody"><p id="ZH-CN_TOPIC_0000001792549932__zh-cn_topic_0000001792549972_p1456922318392">为了防止软件包在传递过程或存储期间被恶意篡改，下载软件包时需下载对应的数字签名文件用于完整性验证。</p>
<p id="ZH-CN_TOPIC_0000001792549932__zh-cn_topic_0000001792549972_p156932333915">在软件包下载之后，请参考《OpenPGP签名验证指南》，对从Support网站下载的软件包进行PGP数字签名校验。如果校验失败，请不要使用该软件包，先联系华为技术支持工程师解决。</p>
<p id="ZH-CN_TOPIC_0000001792549932__zh-cn_topic_0000001792549972_p4569152323915">使用软件包安装/升级之前，也需要按上述过程先验证软件包的数字签名，确保软件包未被篡改。</p>
<p id="ZH-CN_TOPIC_0000001792549932__zh-cn_topic_0000001792549972_p145691623163911">运营商客户请访问：<a href="https://support.huawei.com/carrier/digitalSignatureAction" target="_blank" rel="noopener noreferrer">https://support.huawei.com/carrier/digitalSignatureAction</a></p>
<p id="ZH-CN_TOPIC_0000001792549932__zh-cn_topic_0000001792549972_p1256922316392">企业客户请访问：<a href="https://support.huawei.com/enterprise/zh/tool/pgp-verify-TL1000000054" target="_blank" rel="noopener noreferrer">https://support.huawei.com/enterprise/zh/tool/pgp-verify-TL1000000054</a></p>
</div></div>
</div>
</p></li><li id="ZH-CN_TOPIC_0000001792549932__li06331156125019"><a name="ZH-CN_TOPIC_0000001792549932__li06331156125019"></a><a name="li06331156125019"></a><span>登录分布式块存储管理节点获取证书。</span><p><ol type="a"><li><span style="color:#494949;">使用PuTTY，以</span><strong style="color:#494949;">fsadmin</strong><span style="color:#494949;">账号通过浮动IP地址登录分布式块存储管理节点。</span></li><li><span style="color:#494949;">执行如下</span><span style="color:#494949;">命令，输入</span><strong style="color:#494949;">root</strong><span style="color:#494949;">账号密码切换到</span><strong style="color:#494949;">root</strong><span style="color:#494949;">用户。</span><pre class="screen">su - root</pre>
</li><li>执行如下命令，输入<strong>admin</strong>账户的密码后登录CLI。<pre class="screen">ismcli -u admin</pre>
</li><li>执行如下命令，导出FSM的证书和密钥文件。<pre class="screen">export fsm certificate</pre>
<p>导出过程中需要设置密码，该密码用于对导出文件进行加密。</p>
<div class="p">回显类似如下：<pre class="screen">admin:/&gt;export fsm certificate 
Export password:****** 
Reenter password:******      
fsm certificate path : /opt/omm/oms/workspace/certificate/fsm-server.pem    
fsm key path         : /opt/omm/oms/workspace/certificate/fsm-server.key    
ca certificate path  : /opt/omm/oms/workspace/certificate/ca.pem </pre>
</div>
</li></ol>
</p></li><li id="ZH-CN_TOPIC_0000001792549932__li17527462313"><span>使用WinSCP工具，通过管理IP地址，以<strong id="ZH-CN_TOPIC_0000001792549932__b311984945710">fsadmin</strong>账号登录分布式块存储管理节点，将FSM的证书和密钥文件<span style="color:#252B3A;">（</span>fsm-server.pem、fsm-server.key、ca.pem<span style="color:#252B3A;">）</span>下载到本地。</span><p><div class="note" id="ZH-CN_TOPIC_0000001792549932__note1111311043017"><img src="public_sys-resources/note_3.0-zh-cn.png"><span class="notetitle"> </span><div class="notebody"><p id="ZH-CN_TOPIC_0000001792549932__p41131804301">如果<strong id="ZH-CN_TOPIC_0000001792549932__b1275618774713">fsadmin</strong>用户无FSM的证书和密钥文件<span style="color:#252B3A;">（</span>fsm-server.pem、fsm-server.key、ca.pem<span style="color:#252B3A;">）</span>读写权限，则需先使用<strong id="ZH-CN_TOPIC_0000001792549932__b185617487471">root</strong>用户修改FSM的证书和密钥文件的权限为<strong id="ZH-CN_TOPIC_0000001792549932__b59281511184819">fsadmin</strong>用户可读写，并拷贝至“/home/fsadmin”目录下，再下载到本地。</p>
</div></div>
</p></li><li><span>使用PuTTY，通过管理IP地址，以<strong>root</strong>账号登录代理主机。</span></li><li><span><span style="color:#252B3A;">执行如下命令，创建“/scripts”目录</span>。</span><p><pre class="screen"><span style="color:#252B3A;">mkdir -p /opt/DataBackup/ProtectClient/Plugins/VirtualizationPlugin/vbstool/lib/scripts/</span></pre>
</p></li><li><span>使用WinSCP工具，通过管理IP地址，以<strong>root</strong>账号登录代理主机，将获取到的证书及密钥文件（fsm-server.pem、fsm-server.key、ca.pem）上传到“/opt/DataBackup/ProtectClient/Plugins/VirtualizationPlugin/vbstool/lib/scripts/”目录。</span></li><li><span>执行如下命令，解压jre文件。</span><p><pre class="screen">mkdir -p /opt/DataBackup/ProtectClient/Plugins/VirtualizationPlugin/vbstool/javarunenv/</pre>
<pre class="screen">tar -zmxvf /opt/dsware/agent/jre-*.tar.gz -C /opt/DataBackup/ProtectClient/Plugins/VirtualizationPlugin/vbstool/javarunenv/</pre>
</p></li><li><span>执行如下命令，创建“OceanStor-Pacific<span style="color:#252B3A;">_api</span>”目录。</span><p><pre class="screen"><span style="color:#252B3A;">mkdir -p</span> /opt/OceanStor-Pacific<span style="color:#252B3A;">_api</span></pre>
</p></li><li><span>使用WinSCP工具，通过管理IP地址，以<strong>root</strong>账号登录代理主机，将获取到的API包（OceanStor-Pacific_<em>xxx</em>_API.tar.gz）上传到“/opt/OceanStor-Pacific_api”目录。</span></li><li><span>执行如下命令，解压API包并删除log4j开头的文件。</span><p><pre class="screen">cd /opt/OceanStor-Pacific_api</pre>
<pre class="screen">tar -zmxvf <em>OceanStor-Pacific_xxx_API.tar.gz</em></pre>
<pre class="screen">cd OceanStor-Pacific_<em>xxx</em>_API</pre>
<pre class="screen">rm -rf lib/log4j-*</pre>
<div class="note"><img src="public_sys-resources/note_3.0-zh-cn.png"><span class="notetitle"> </span><div class="notebody"><p>OceanStor-Pacific_<em>xxx</em>_API.tar.gz是<a href="#ZH-CN_TOPIC_0000001792549932__li116039278213">1</a>获取的API包，如OceanStor-Pacific_8.1.2_API.tar.gz。</p>
</div></div>
</p></li><li id="ZH-CN_TOPIC_0000001792549932__li121290407536"><a name="ZH-CN_TOPIC_0000001792549932__li121290407536"></a><a name="li121290407536"></a><span>请执行如下命令，拷贝文件。</span><p><div class="note"><img src="public_sys-resources/note_3.0-zh-cn.png"><span class="notetitle"> </span><div class="notebody"><p>命令中的<em>xxx</em>表示API包解压后的目录，请根据实际替换。例如API包为OceanStor-Pacific_8.1.2_API.tar.gz，解压后的目录为OceanStor-Pacific_8.1.2_API。</p>
</div></div>
<ul><li>如果是OceanStor Pacific 8.1.2及之前版本，请执行以下命令：<pre class="screen">cd <em>xxx</em></pre>
<pre class="screen">cp client_self.keystore client_trust.keystore dsware-api.properties fsa_server.key manager-ssl.properties primary_ks.key standby_ks.key /opt/DataBackup/ProtectClient/Plugins/VirtualizationPlugin/vbstool/conf</pre>
<pre class="screen">cp dr_cli.xml readme.txt version zk-client.jks /opt/DataBackup/ProtectClient/Plugins/VirtualizationPlugin/vbstool/conf</pre>
<pre class="screen">cp dsware-api-*.jar /opt/DataBackup/ProtectClient/Plugins/VirtualizationPlugin/vbstool/lib/</pre>
<pre class="screen">cp primary_ks.key standby_ks.key /opt/DataBackup/ProtectClient/Plugins/VirtualizationPlugin/vbstool/lib/</pre>
<pre class="screen">cp -r scripts/* /opt/DataBackup/ProtectClient/Plugins/VirtualizationPlugin/vbstool/lib/scripts/</pre>
<pre class="screen">cp -r lib/* /opt/DataBackup/ProtectClient/Plugins/VirtualizationPlugin/vbstool/lib/</pre>
</li><li>如果是OceanStor Pacific 8.1.3及之后版本，请执行以下命令：<pre class="screen">cd <em>xxx</em></pre>
<pre class="screen">cp client_self.keystore client_trust.keystore dsware-api.properties manager-ssl.properties primary_ks.key standby_ks.key /opt/DataBackup/ProtectClient/Plugins/VirtualizationPlugin/vbstool/conf</pre>
<pre class="screen">cp dr_cli.xml readme.txt version zk-client.jks /opt/DataBackup/ProtectClient/Plugins/VirtualizationPlugin/vbstool/conf</pre>
<pre class="screen">cp dsware-api-*.jar /opt/DataBackup/ProtectClient/Plugins/VirtualizationPlugin/vbstool/lib/</pre>
<pre class="screen">cp primary_ks.key standby_ks.key /opt/DataBackup/ProtectClient/Plugins/VirtualizationPlugin/vbstool/lib/</pre>
<pre class="screen">cp -r scripts/* /opt/DataBackup/ProtectClient/Plugins/VirtualizationPlugin/vbstool/lib/scripts/</pre>
<pre class="screen">cp -r lib/* /opt/DataBackup/ProtectClient/Plugins/VirtualizationPlugin/vbstool/lib/</pre>
<div class="note"><img src="public_sys-resources/note_3.0-zh-cn.png"><span class="notetitle"> </span><div class="notebody"><p>如果命令执行过程中提示<strong>client_self.keystore</strong>、<strong>client_trust.keystore</strong>或<strong>zk-client.jks</strong>文件不存在，请先忽略。</p>
</div></div>
</li></ul>
</p></li><li><span>执行如下命令，拷贝so文件。</span><p><ul><li>ProtectAgent为x86架构，请执行以下命令：<pre class="screen">cp -r /opt/DataBackup/ProtectClient/Plugins/VirtualizationPlugin/vbstool/lib/linux-x86-64/* /opt/DataBackup/ProtectClient/Plugins/VirtualizationPlugin/vbstool/lib/</pre>
</li></ul>
<ul><li>ProtectAgent为ARM架构，请执行以下命令：<pre class="screen">cp -r /opt/DataBackup/ProtectClient/Plugins/VirtualizationPlugin/vbstool/lib/linux-aarch64/* /opt/DataBackup/ProtectClient/Plugins/VirtualizationPlugin/vbstool/lib/</pre>
</li></ul>
</p></li><li id="ZH-CN_TOPIC_0000001792549932__li1866134635319"><a name="ZH-CN_TOPIC_0000001792549932__li1866134635319"></a><a name="li1866134635319"></a><span>执行如下命令，导入环境变量。</span><p><ul><li>ProtectAgent为x86架构，请执行以下命令：<pre class="screen">export LD_LIBRARY_PATH=/usr/lib64:/opt/DataBackup/ProtectClient/Plugins/VirtualizationPlugin/vbstool/lib/linux-x86-64</pre>
</li><li>ProtectAgent为ARM架构，请执行以下命令：<pre class="screen">export LD_LIBRARY_PATH=/usr/lib64:/opt/DataBackup/ProtectClient/Plugins/VirtualizationPlugin/vbstool/lib/linux-aarch64</pre>
</li></ul>
</p></li><li id="ZH-CN_TOPIC_0000001792549932__li4984185795917"><a name="ZH-CN_TOPIC_0000001792549932__li4984185795917"></a><a name="li4984185795917"></a><span>执行如下命令，替换证书。</span><p><pre class="screen">JAVA_HOME=$(find /opt/DataBackup/ProtectClient/Plugins/VirtualizationPlugin/vbstool/javarunenv -mindepth 1 -maxdepth 1 -type d)</pre>
<pre class="screen">sh /opt/DataBackup/ProtectClient/Plugins/VirtualizationPlugin/vbstool/lib/scripts/replace_cert.sh -s /opt/DataBackup/ProtectClient/Plugins/VirtualizationPlugin/vbstool/lib/scripts/fsm-server.pem -c /opt/DataBackup/ProtectClient/Plugins/VirtualizationPlugin/vbstool/lib/scripts/ca.pem -k /opt/DataBackup/ProtectClient/Plugins/VirtualizationPlugin/vbstool/lib/scripts/fsm-server.key -f <em>FSM浮动IP</em> -j $JAVA_HOME</pre>
<div class="note"><img src="public_sys-resources/note_3.0-zh-cn.png"><span class="notetitle"> </span><div class="notebody"><p><span style="color:#252B3A;">替换过程中需要输入证书的密码，为</span><a href="#ZH-CN_TOPIC_0000001792549932__li06331156125019">2</a><span style="color:#252B3A;">中设置的密码。</span></p>
</div></div>
<ul><li>对于OceanStor Pacific 8.1.2及之前版本，当“/opt/DataBackup/ProtectClient/Plugins/VirtualizationPlugin/vbstool/conf/cert/<em>FSM浮动IP地址</em>/”目录下存在client_self.keystore、client_trust.keystore以及dsware-api.properties时，表示证书导入成功。</li><li>对于OceanStor Pacific 8.1.3及之后版本，当“/opt/DataBackup/ProtectClient/Plugins/VirtualizationPlugin/vbstool/conf/cert/<em>FSM浮动IP地址</em>/”目录下存在dsware-api.properties时，表示证书导入成功。</li></ul>
</p></li><li><span>如果<a href="#ZH-CN_TOPIC_0000001792549932__li121290407536">11</a>中提示<strong>client_self.keystore</strong>和<strong>client_trust.keystore</strong>文件不存在，请执行以下命令拷贝文件。其他场景请跳过本步骤。</span><p><pre class="screen">cd /opt/DataBackup/ProtectClient/Plugins/VirtualizationPlugin/vbstool/conf/cert/<em>FSM浮动IP地址</em>/
cp client_self.keystore client_trust.keystore /opt/DataBackup/ProtectClient/Plugins/VirtualizationPlugin/vbstool/conf</pre>
</p></li></ol>
</div>
<div class="section"><h4 class="sectiontitle">修改备份方式</h4><p>外置代理的备份方式默认为<span class="parmvalue">“VBS”</span>，如果需要使用同一外置代理对接多套<span style="color:#252B3A;">OceanStor Pacific</span>集群，则需指定备份方式为<span class="parmvalue">“ISCSI”</span>，修改操作如下：</p>
<ol><li id="ZH-CN_TOPIC_0000001792549932__zh-cn_topic_0000001792549972_zh-cn_topic_0000001356308068_li152465173517"><span>使用PuTTY，通过管理IP地址，以<strong id="ZH-CN_TOPIC_0000001792549932__zh-cn_topic_0000001792549972_zh-cn_topic_0000001792390308_zh-cn_topic_0000001356308068_b19645855102114">root</strong>账户登录代理主机。</span></li><li id="ZH-CN_TOPIC_0000001792549932__zh-cn_topic_0000001792549972_li196517513393"><span>执行以下命令，设置配置文件中的<span class="parmname" id="ZH-CN_TOPIC_0000001792549932__zh-cn_topic_0000001792549972_parmname15271411115">“FusionStorageApiMode”</span>配置项为<span class="parmvalue" id="ZH-CN_TOPIC_0000001792549932__zh-cn_topic_0000001792549972_parmvalue14880145816019">“ISCSI”</span>。</span><p><p id="ZH-CN_TOPIC_0000001792549932__zh-cn_topic_0000001792549972_p12512182813399"><strong id="ZH-CN_TOPIC_0000001792549932__zh-cn_topic_0000001792549972_b52461854124714">vi </strong><em id="ZH-CN_TOPIC_0000001792549932__zh-cn_topic_0000001792549972_i11611125754718">/opt</em><strong id="ZH-CN_TOPIC_0000001792549932__zh-cn_topic_0000001792549972_b1124620545476">/DataBackup/ProtectClient/Plugins/VirtualizationPlugin/conf/hcpconf.ini</strong></p>
<div class="note" id="ZH-CN_TOPIC_0000001792549932__zh-cn_topic_0000001792549972_note88645224472"><img src="public_sys-resources/note_3.0-zh-cn.png"><span class="notetitle"> </span><div class="notebody"><p id="ZH-CN_TOPIC_0000001792549932__zh-cn_topic_0000001792549972_p28641722154719">命令中的<em id="ZH-CN_TOPIC_0000001792549932__zh-cn_topic_0000001792549972_i2153220484">/opt</em>请根据ProtectAgent的实际安装目录替换。</p>
</div></div>
<p id="ZH-CN_TOPIC_0000001792549932__zh-cn_topic_0000001792549972_p15116171715211">示例：</p>
<pre class="screen" id="ZH-CN_TOPIC_0000001792549932__zh-cn_topic_0000001792549972_screen19257231522">FusionStorageApiMode=ISCSI</pre>
</p></li></ol>
</div>
</div>

<div class="hrcopyright"><hr size="2"></div><div class="hwcopyright">版权所有 &copy; 华为技术有限公司</div></body>
</html>