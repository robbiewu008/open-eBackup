
<!DOCTYPE html
  PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html lang="en-us" xml:lang="en-us">
<head>
      <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
   
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="DC.Type" content="topic">
<meta name="DC.Title" content="Adding an Agent Host to Huawei Scale-Out Storage OceanStor Pacific (Applicable to Huawei Cloud Stack)">
<meta name="DC.Format" content="XHTML">
<meta name="DC.Identifier" content="EN-US_TOPIC_0000001792549932">
<meta name="DC.Language" content="en-us">
<link rel="stylesheet" type="text/css" href="public_sys-resources/commonltr.css">
<title>Adding an Agent Host to Huawei Scale-Out Storage OceanStor Pacific (Applicable to Huawei Cloud Stack)</title>
</head>
<body style="clear:both; padding-left:10px; padding-top:5px; padding-right:5px; padding-bottom:5px"><a name="EN-US_TOPIC_0000001792549932"></a><a name="EN-US_TOPIC_0000001792549932"></a>

<h1 class="topictitle1">Adding an Agent Host to Huawei Scale-Out Storage OceanStor Pacific (Applicable to Huawei Cloud Stack)</h1>
<div><p>If the storage resources of Huawei Cloud Stack are Huawei scale-out block storage OceanStor Pacific and a reverse proxy is configured, follow the instructions in this section to connect the agent host to Huawei scale-out storage as a VBS client and replace certificates, ensuring that the agent host can access Huawei scale-out block storage.</p>
<div class="section"><h4 class="sectiontitle">Installing VBS</h4><p id="EN-US_TOPIC_0000001792549932__en-us_topic_0000001792549972_p04301219055">For details about how to install the VBS service, see section "Allocating Storage Space (SCSI Protocol-Linux)" &gt; "Creating VBS on Compute Nodes" in <em id="EN-US_TOPIC_0000001792549932__en-us_topic_0000001792549972_i847618142122">Product Documentation</em> of the corresponding storage product version. A compute node is an agent host. Set the following parameters as required. Set other parameters based on the document requirements.</p>
<ul id="EN-US_TOPIC_0000001792549932__en-us_topic_0000001792549972_ul996111581773"><li id="EN-US_TOPIC_0000001792549932__en-us_topic_0000001792549972_li1096110589719"><strong id="EN-US_TOPIC_0000001792549932__en-us_topic_0000001792549972_b1046454115581">Management IP Address</strong>: Enter the management IP address of the agent host.</li><li id="EN-US_TOPIC_0000001792549932__en-us_topic_0000001792549972_li149611258279"><strong id="EN-US_TOPIC_0000001792549932__en-us_topic_0000001792549972_b1040995525818">Cabinet</strong>: Specify the cabinet where the agent host is located. It can be any value.</li><li id="EN-US_TOPIC_0000001792549932__en-us_topic_0000001792549972_li49619581879"><strong id="EN-US_TOPIC_0000001792549932__en-us_topic_0000001792549972_b19708985915">Node Role</strong>: Select <strong id="EN-US_TOPIC_0000001792549932__en-us_topic_0000001792549972_b1363373045810">Compute</strong>.</li><li id="EN-US_TOPIC_0000001792549932__en-us_topic_0000001792549972_li119612582075"><strong id="EN-US_TOPIC_0000001792549932__en-us_topic_0000001792549972_b892811256173">Installation Mode</strong>: Select <strong id="EN-US_TOPIC_0000001792549932__en-us_topic_0000001792549972_b1693082531719">Regular installation</strong>.</li></ul>
</div>
<div class="section"><h4 class="sectiontitle">Replacing OceanStor Pacific Certificates</h4><ol><li id="EN-US_TOPIC_0000001792549932__li116039278213"><a name="EN-US_TOPIC_0000001792549932__li116039278213"></a><a name="li116039278213"></a><span>Log in to the technical support website and obtain the OceanStor Pacific API package for Huawei Cloud Stack.</span><p><div class="p" id="EN-US_TOPIC_0000001792549932__p560372712219">To obtain the API package, go to the following path:<ul id="EN-US_TOPIC_0000001792549932__ul46031271529"><li id="EN-US_TOPIC_0000001792549932__li2060382719212">For enterprise users: <a href="https://support.huawei.com/enterprise/en/distributed-storage/oceanstor-pacific-9520-pid-251711061/software" target="_blank" rel="noopener noreferrer">Click here.</a></li><li id="EN-US_TOPIC_0000001792549932__li5603102711218">For carrier users: <a href="https://support.huawei.com/carrier/productNewOffering?col=product&amp;path=PBI1-21430725/PBI1-251363742/PBI1-21431663/PBI1-251366323/PBI1-251711061&amp;resTab=SW" target="_blank" rel="noopener noreferrer">Click here.</a></li></ul>
</div>
<p id="EN-US_TOPIC_0000001792549932__p142401833143418">The API package name is <strong id="EN-US_TOPIC_0000001792549932__b15114735164219">OceanStor-Pacific_</strong><em id="EN-US_TOPIC_0000001792549932__i5114835154212">xxx</em><strong id="EN-US_TOPIC_0000001792549932__b13114153524219">_API.tar.gz</strong>, for example, <strong id="EN-US_TOPIC_0000001792549932__b7114123513424">OceanStor-Pacific_8.1.2_API.tar.gz</strong>.</p>
<div class="p" id="EN-US_TOPIC_0000001792549932__p5603927626"><em id="EN-US_TOPIC_0000001792549932__i137061746164219">xxx</em> indicates the product version. The API software package name may be in uppercase or lowercase, depending on the version.<div class="note" id="EN-US_TOPIC_0000001792549932__note15603527525"><img src="public_sys-resources/note_3.0-en-us.png"><span class="notetitle"> </span><div class="notebody"><p id="EN-US_TOPIC_0000001792549932__en-us_topic_0000001792549972_p1456922318392">To prevent the software package from being maliciously tampered with during transmission or storage, download the corresponding digital signature file for integrity verification while downloading the software package.</p>
<p id="EN-US_TOPIC_0000001792549932__en-us_topic_0000001792549972_p156932333915">After the software package is downloaded from the Huawei Support website, verify the PGP digital signature by referring to the <em id="EN-US_TOPIC_0000001792549932__en-us_topic_0000001792549972_i196531028162319">OpenPGP Signature Verification Guide</em>. If the verification fails, do not use the software package, and contact Huawei technical support.</p>
<p id="EN-US_TOPIC_0000001792549932__en-us_topic_0000001792549972_p4569152323915">Before a software package is used in installation or upgrade, its digital signature also needs to be verified according to the <em id="EN-US_TOPIC_0000001792549932__en-us_topic_0000001792549972_i178983813268">OpenPGP Signature Verification Guide</em> to ensure that the software package is not tampered with. Visit either of the following websites to obtain the <em id="EN-US_TOPIC_0000001792549932__en-us_topic_0000001792549972_i148991289269">OpenPGP Signature Verification Guide</em>:</p>
<p id="EN-US_TOPIC_0000001792549932__en-us_topic_0000001792549972_p145691623163911">For carrier users, visit <a href="https://support.huawei.com/carrier/digitalSignatureAction" target="_blank" rel="noopener noreferrer">https://support.huawei.com/carrier/digitalSignatureAction</a>.</p>
<p id="EN-US_TOPIC_0000001792549932__en-us_topic_0000001792549972_p1256922316392">For enterprise users, visit <a href="https://support.huawei.com/enterprise/en/tool/pgp-verify-TL1000000054" target="_blank" rel="noopener noreferrer">https://support.huawei.com/enterprise/en/tool/pgp-verify-TL1000000054</a>.</p>
</div></div>
</div>
</p></li><li id="EN-US_TOPIC_0000001792549932__li06331156125019"><a name="EN-US_TOPIC_0000001792549932__li06331156125019"></a><a name="li06331156125019"></a><span>Log in to the scale-out block storage management node to obtain certificates.</span><p><ol type="a"><li>Use PuTTY to log in to the scale-out block storage management node as user <strong>fsadmin</strong> through the floating IP address.</li><li>Run the following command and enter the password of user <strong>root</strong> to switch to user <strong>root</strong>.<pre class="screen">su - root</pre>
</li><li>Run the following command and enter the password of user <strong>admin</strong> to log in to the CLI.<pre class="screen">ismcli -u admin</pre>
</li><li>Run the following command to export FSM's certificate and key files.<pre class="screen">export fsm certificate</pre>
<p>A password used to encrypt the exported files needs to be set during the export.</p>
<div class="p">Command output similar to the following is displayed:<pre class="screen">admin:/&gt;export fsm certificate 
Export password:****** 
Reenter password:******      
fsm certificate path : /opt/omm/oms/workspace/certificate/fsm-server.pem    
fsm key path         : /opt/omm/oms/workspace/certificate/fsm-server.key    
ca certificate path  : /opt/omm/oms/workspace/certificate/ca.pem </pre>
</div>
</li></ol>
</p></li><li id="EN-US_TOPIC_0000001792549932__li17527462313"><span>Use WinSCP to log in to the scale-out block storage management node as user <strong id="EN-US_TOPIC_0000001792549932__b1242463081510">fsadmin</strong> through the management IP address and download FSM's certificate and key files (<strong id="EN-US_TOPIC_0000001792549932__b154241730161516">fsm-server.pem</strong>, <strong id="EN-US_TOPIC_0000001792549932__b34240304159">fsm-server.key</strong>, and <strong id="EN-US_TOPIC_0000001792549932__b9424173031515">ca.pem</strong>) to a local directory.</span><p><div class="note" id="EN-US_TOPIC_0000001792549932__note1111311043017"><img src="public_sys-resources/note_3.0-en-us.png"><span class="notetitle"> </span><div class="notebody"><p id="EN-US_TOPIC_0000001792549932__p41131804301">If user <strong id="EN-US_TOPIC_0000001792549932__b12625331191510">fsadmin</strong> does not have the read and write permissions on FSM's certificate and key files (<strong id="EN-US_TOPIC_0000001792549932__b146251131121514">fsm-server.pem</strong>, <strong id="EN-US_TOPIC_0000001792549932__b5625143151519">fsm-server.key</strong>, and <strong id="EN-US_TOPIC_0000001792549932__b11625123110155">ca.pem</strong>), use user <strong id="EN-US_TOPIC_0000001792549932__b15625931111511">root</strong> to enable the read and write permissions on FSM's certificate and key files for user <strong id="EN-US_TOPIC_0000001792549932__b7625133121515">fsadmin</strong>, copy the files to the <strong id="EN-US_TOPIC_0000001792549932__b12625153110154">/home/fsadmin</strong> directory, and download them to a local directory.</p>
</div></div>
</p></li><li><span>Use PuTTY to log in to the agent host as user <strong>root</strong> through the management IP address.</span></li><li><span>Run the following command to create the <strong>/scripts</strong> directory:</span><p><pre class="screen">mkdir -p /opt/DataBackup/ProtectClient/Plugins/VirtualizationPlugin/vbstool/lib/scripts/</pre>
</p></li><li><span>Use WinSCP to log in to the agent host as user <strong>root</strong> through the management IP address, and upload the obtained certificate and key files (<strong>fsm-server.pem</strong>, <strong>fsm-server.key</strong>, and <strong>ca.pem</strong>) to the <strong>/opt/DataBackup/ProtectClient/Plugins/VirtualizationPlugin/vbstool/lib/scripts/</strong> directory.</span></li><li><span>Run the following commands to decompress the JRE file:</span><p><pre class="screen">mkdir -p /opt/DataBackup/ProtectClient/Plugins/VirtualizationPlugin/vbstool/javarunenv/</pre>
<pre class="screen">tar -zmxvf /opt/dsware/agent/jre-*.tar.gz -C /opt/DataBackup/ProtectClient/Plugins/VirtualizationPlugin/vbstool/javarunenv/</pre>
</p></li><li><span>Run the following command to create the <strong>OceanStor-Pacific_api</strong> directory:</span><p><pre class="screen">mkdir -p /opt/OceanStor-Pacific_api</pre>
</p></li><li><span>Use WinSCP to log in to the agent host as user <strong>root</strong> through the management IP address and upload the obtained API package (<strong>OceanStor-Pacific_</strong><em>xxx</em><strong>_API.tar.gz</strong>) to the <strong>/opt/OceanStor-Pacific_api</strong> directory.</span></li><li><span>Decompress the API package and delete the files whose names start with <strong>log4j</strong>.</span><p><pre class="screen">cd /opt/OceanStor-Pacific_api</pre>
<pre class="screen">tar -zmxvf <em>OceanStor-Pacific_xxx_API.tar.gz</em></pre>
<pre class="screen">cd OceanStor-Pacific_<em>xxx</em>_API</pre>
<pre class="screen">rm -rf lib/log4j-*</pre>
<div class="note"><img src="public_sys-resources/note_3.0-en-us.png"><span class="notetitle"> </span><div class="notebody"><p><strong>OceanStor-Pacific_</strong><em>xxx</em><strong>_API.tar.gz</strong> is the API package obtained in <a href="#EN-US_TOPIC_0000001792549932__li116039278213">1</a>, for example, <strong>OceanStor-Pacific_8.1.2_API.tar.gz</strong>.</p>
</div></div>
</p></li><li id="EN-US_TOPIC_0000001792549932__li121290407536"><a name="EN-US_TOPIC_0000001792549932__li121290407536"></a><a name="li121290407536"></a><span>Run the following commands to copy the files:</span><p><div class="note"><img src="public_sys-resources/note_3.0-en-us.png"><span class="notetitle"> </span><div class="notebody"><p>In the command, <em>xxx</em> indicates the directory generated after the API package is decompressed. Change it based on the site requirements. For example, if the API package is <strong>OceanStor-Pacific_8.1.2_API.tar.gz</strong>, the directory generated after the decompression is <strong>OceanStor-Pacific_8.1.2_API</strong>.</p>
</div></div>
<ul><li>For OceanStor Pacific 8.1.2 and earlier versions, run the following commands:<pre class="screen">cd <em>xxx</em></pre>
<pre class="screen">cp client_self.keystore client_trust.keystore dsware-api.properties fsa_server.key manager-ssl.properties primary_ks.key standby_ks.key /opt/DataBackup/ProtectClient/Plugins/VirtualizationPlugin/vbstool/conf</pre>
<pre class="screen">cp dr_cli.xml readme.txt version zk-client.jks /opt/DataBackup/ProtectClient/Plugins/VirtualizationPlugin/vbstool/conf</pre>
<pre class="screen">cp dsware-api-*.jar /opt/DataBackup/ProtectClient/Plugins/VirtualizationPlugin/vbstool/lib/</pre>
<pre class="screen">cp primary_ks.key standby_ks.key /opt/DataBackup/ProtectClient/Plugins/VirtualizationPlugin/vbstool/lib/</pre>
<pre class="screen">cp -r scripts/* /opt/DataBackup/ProtectClient/Plugins/VirtualizationPlugin/vbstool/lib/scripts/</pre>
<pre class="screen">cp -r lib/* /opt/DataBackup/ProtectClient/Plugins/VirtualizationPlugin/vbstool/lib/</pre>
</li><li>For OceanStor Pacific 8.1.3 and later versions, run the following commands:<pre class="screen">cd <em>xxx</em></pre>
<pre class="screen">cp client_self.keystore client_trust.keystore dsware-api.properties manager-ssl.properties primary_ks.key standby_ks.key /opt/DataBackup/ProtectClient/Plugins/VirtualizationPlugin/vbstool/conf</pre>
<pre class="screen">cp dr_cli.xml readme.txt version zk-client.jks /opt/DataBackup/ProtectClient/Plugins/VirtualizationPlugin/vbstool/conf</pre>
<pre class="screen">cp dsware-api-*.jar /opt/DataBackup/ProtectClient/Plugins/VirtualizationPlugin/vbstool/lib/</pre>
<pre class="screen">cp primary_ks.key standby_ks.key /opt/DataBackup/ProtectClient/Plugins/VirtualizationPlugin/vbstool/lib/</pre>
<pre class="screen">cp -r scripts/* /opt/DataBackup/ProtectClient/Plugins/VirtualizationPlugin/vbstool/lib/scripts/</pre>
<pre class="screen">cp -r lib/* /opt/DataBackup/ProtectClient/Plugins/VirtualizationPlugin/vbstool/lib/</pre>
<div class="note"><img src="public_sys-resources/note_3.0-en-us.png"><span class="notetitle"> </span><div class="notebody"><p>During the command execution, if a message is displayed indicating that the <strong>client_self.keystore</strong>, <strong>client_trust.keystore</strong>, or <strong>zk-client.jks</strong> file does not exist, ignore it.</p>
</div></div>
</li></ul>
</p></li><li><span>Run the following command to copy the <strong>so</strong> file.</span><p><ul><li>If ProtectAgent uses the x86 architecture, run the following command:<pre class="screen">cp -r /opt/DataBackup/ProtectClient/Plugins/VirtualizationPlugin/vbstool/lib/linux-x86-64/* /opt/DataBackup/ProtectClient/Plugins/VirtualizationPlugin/vbstool/lib/</pre>
</li></ul>
<ul><li>If ProtectAgent uses the Arm architecture, run the following command:<pre class="screen">cp -r /opt/DataBackup/ProtectClient/Plugins/VirtualizationPlugin/vbstool/lib/linux-aarch64/* /opt/DataBackup/ProtectClient/Plugins/VirtualizationPlugin/vbstool/lib/</pre>
</li></ul>
</p></li><li id="EN-US_TOPIC_0000001792549932__li1866134635319"><a name="EN-US_TOPIC_0000001792549932__li1866134635319"></a><a name="li1866134635319"></a><span>Run the following command to import environment variables:</span><p><ul><li>If ProtectAgent uses the x86 architecture, run the following command:<pre class="screen">export LD_LIBRARY_PATH=/usr/lib64:/opt/DataBackup/ProtectClient/Plugins/VirtualizationPlugin/vbstool/lib/linux-x86-64</pre>
</li><li>If ProtectAgent uses the Arm architecture, run the following command:<pre class="screen">export LD_LIBRARY_PATH=/usr/lib64:/opt/DataBackup/ProtectClient/Plugins/VirtualizationPlugin/vbstool/lib/linux-aarch64</pre>
</li></ul>
</p></li><li id="EN-US_TOPIC_0000001792549932__li4984185795917"><a name="EN-US_TOPIC_0000001792549932__li4984185795917"></a><a name="li4984185795917"></a><span>Run the following commands to replace the certificates.</span><p><pre class="screen">JAVA_HOME=$(find /opt/DataBackup/ProtectClient/Plugins/VirtualizationPlugin/vbstool/javarunenv -mindepth 1 -maxdepth 1 -type d)</pre>
<pre class="screen">sh /opt/DataBackup/ProtectClient/Plugins/VirtualizationPlugin/vbstool/lib/scripts/replace_cert.sh -s /opt/DataBackup/ProtectClient/Plugins/VirtualizationPlugin/vbstool/lib/scripts/fsm-server.pem -c /opt/DataBackup/ProtectClient/Plugins/VirtualizationPlugin/vbstool/lib/scripts/ca.pem -k /opt/DataBackup/ProtectClient/Plugins/VirtualizationPlugin/vbstool/lib/scripts/fsm-server.key -f <em>FSM floating IP address</em> -j $JAVA_HOME</pre>
<div class="note"><img src="public_sys-resources/note_3.0-en-us.png"><span class="notetitle"> </span><div class="notebody"><p>During the replacement, you need to enter the certificate password, which is the password set in <a href="#EN-US_TOPIC_0000001792549932__li06331156125019">2</a>.</p>
</div></div>
<ul><li>For OceanStor Pacific 8.1.2 and earlier versions, if <strong>client_self.keystore</strong>, <strong>client_trust.keystore</strong>, and <strong>dsware-api.properties</strong> exist in the <strong>/opt/DataBackup/ProtectClient/Plugins/VirtualizationPlugin/vbstool/conf/cert/</strong><em>FSM floating IP address</em><strong>/</strong> directory, the certificates are successfully imported.</li><li>For OceanStor Pacific 8.1.3 and later versions, if <strong>dsware-api.properties</strong> exists in the <strong>/opt/DataBackup/ProtectClient/Plugins/VirtualizationPlugin/vbstool/conf/cert/</strong><em>FSM floating IP address</em><strong>/</strong> directory, the certificate is successfully imported.</li></ul>
</p></li><li><span>If the system displays a message indicating that the <strong>client_self.keystore</strong> and <strong>client_trust.keystore</strong> files do not exist in <a href="#EN-US_TOPIC_0000001792549932__li121290407536">11</a>, run the following commands to copy the files: In other scenarios, skip this step.</span><p><pre class="screen">cd /opt/DataBackup/ProtectClient/Plugins/VirtualizationPlugin/vbstool/conf/cert/<em>FSM floating IP address</em>/
cp client_self.keystore client_trust.keystore /opt/DataBackup/ProtectClient/Plugins/VirtualizationPlugin/vbstool/conf</pre>
</p></li></ol>
</div>
<div class="section"><h4 class="sectiontitle">Changing the Backup Mode</h4><p>The default backup mode of an external agent is <span class="parmvalue"><b>VBS</b></span>. If you want to use an external agent to connect to multiple OceanStor Pacific clusters, set the backup mode to <span class="parmvalue"><b>ISCSI</b></span>. To change the backup mode, perform the following steps:</p>
<ol><li id="EN-US_TOPIC_0000001792549932__en-us_topic_0000001792549972_en-us_topic_0000001356308068_li152465173517"><span>Use PuTTY to log in to the agent host as user <strong id="EN-US_TOPIC_0000001792549932__en-us_topic_0000001792549972_en-us_topic_0000001792390308_b353514585163">root</strong> through the management IP address.</span></li><li id="EN-US_TOPIC_0000001792549932__en-us_topic_0000001792549972_li196517513393"><span>Run the following command to set <span class="parmname" id="EN-US_TOPIC_0000001792549932__en-us_topic_0000001792549972_parmname15271411115"><b>FusionStorageApiMode</b></span> in the configuration file to <span class="parmvalue" id="EN-US_TOPIC_0000001792549932__en-us_topic_0000001792549972_parmvalue14880145816019"><b>ISCSI</b></span>:</span><p><p id="EN-US_TOPIC_0000001792549932__en-us_topic_0000001792549972_p12512182813399"><strong id="EN-US_TOPIC_0000001792549932__en-us_topic_0000001792549972_b52461854124714">vi </strong><em id="EN-US_TOPIC_0000001792549932__en-us_topic_0000001792549972_i11611125754718">/opt</em><strong id="EN-US_TOPIC_0000001792549932__en-us_topic_0000001792549972_b1124620545476">/DataBackup/ProtectClient/Plugins/VirtualizationPlugin/conf/hcpconf.ini</strong></p>
<div class="note" id="EN-US_TOPIC_0000001792549932__en-us_topic_0000001792549972_note88645224472"><img src="public_sys-resources/note_3.0-en-us.png"><span class="notetitle"> </span><div class="notebody"><p id="EN-US_TOPIC_0000001792549932__en-us_topic_0000001792549972_p28641722154719">Replace <em id="EN-US_TOPIC_0000001792549932__en-us_topic_0000001792549972_i10652713105610">/opt</em> in the command with the actual ProtectAgent installation directory.</p>
</div></div>
<p id="EN-US_TOPIC_0000001792549932__en-us_topic_0000001792549972_p15116171715211">Example:</p>
<pre class="screen" id="EN-US_TOPIC_0000001792549932__en-us_topic_0000001792549972_screen19257231522">FusionStorageApiMode=ISCSI</pre>
</p></li></ol>
</div>
</div>

<div class="hrcopyright"><hr size="2"></div><div class="hwcopyright">Copyright &copy; Huawei Technologies Co., Ltd.</div></body>
</html>