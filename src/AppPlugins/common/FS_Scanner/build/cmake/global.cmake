option(LLT "Compile in LLT mode" OFF)
option(ASAN "Compile in ASAN mode" OFF)
option(TSAN "Compile in TSAN mode" OFF)
option(DTFUZZ "Compile in DTFUZZ mode" OFF)

if(TARGET safe_cmplib)
    MESSAGE(STATUS "safe_cmplib existed")
else()
    add_library(safe_cmplib INTERFACE)
    if("${CMAKE_HOST_SYSTEM_NAME}" STREQUAL "AIX")
        target_compile_options(safe_cmplib INTERFACE -fPIC -maix64 -pthread -shared -pipe -Wl,-b64)
        target_link_options(safe_cmplib INTERFACE -maix64 -pthread -Wl,-bbigtoc)
    elseif ("${CMAKE_HOST_SYSTEM_NAME}" STREQUAL "SunOS")
        target_compile_options(safe_cmplib INTERFACE -fPIC -pthread -pipe -fstack-protector-strong -Wl,-b64 -shared)
        target_link_options(safe_cmplib INTERFACE -pthread -Wl,-z,now)
    else()
        target_compile_options(safe_cmplib INTERFACE -fPIC -pipe -fstack-protector-strong)
        target_link_options(safe_cmplib INTERFACE -Wl,-z,relro -Wl,-z,now -Wl,-z,noexecstack)
    endif()
endif()

if ("${CMAKE_HOST_SYSTEM_NAME}" STREQUAL "SunOS")
    add_definitions(-DSOLARIS)
endif()

if(TARGET safe_cmpexec)
    MESSAGE(STATUS "safe_cmpexec existed")
elseif ("${CMAKE_HOST_SYSTEM_NAME}" STREQUAL "SunOS")
    add_library(safe_cmpexec INTERFACE)
    target_compile_options(safe_cmpexec INTERFACE -fPIC -pipe -fstack-protector-strong)
    target_link_options(safe_cmpexec INTERFACE -fpie -Wl,-z,now)
else()
    add_library(safe_cmpexec INTERFACE)
    target_compile_options(safe_cmpexec INTERFACE -fPIC -pipe -fstack-protector-strong)
    target_link_options(safe_cmpexec INTERFACE -fpie -Wl,-z,relro -Wl,-z,now -Wl,-z,noexecstack -pie)
endif()

if(TARGET tcmalloc_cmpexec)
    MESSAGE(STATUS "tcmalloc_cmpexec existed")
else()
    add_library(tcmalloc_cmpexec INTERFACE)
    target_compile_options(tcmalloc_cmpexec INTERFACE -DENABLE_TCMALLOC)
endif()


if(CMAKE_BUILD_TYPE STREQUAL "Release")
    message(STATUS "Build release version")
    if ("${CMAKE_HOST_SYSTEM_NAME}" STREQUAL "SunOS")
        target_link_options(safe_cmplib INTERFACE "-fstack-protector-strong" "-Wl,-z,now" "-fstack-check" "-D_FORTIFY_SOURCE=2 -O2" "-flto" "-s")
    else()
        target_link_options(safe_cmplib INTERFACE "-fstack-protector-strong" "-Wl,-z,now" "-Wl,-z,relro" "-fstack-check" "-D_FORTIFY_SOURCE=2 -O2" "-flto" "-s")
    endif()
    target_link_options(safe_cmpexec INTERFACE -s)
else()
    target_compile_options(safe_cmplib INTERFACE -g)
    target_link_options(safe_cmplib INTERFACE -g)
    target_compile_options(safe_cmpexec INTERFACE -g)
    target_link_options(safe_cmpexec INTERFACE -g)
endif()

if(LLT)
    target_compile_options(safe_cmplib INTERFACE --coverage)
    target_link_options(safe_cmplib INTERFACE --coverage)
    target_compile_options(safe_cmpexec INTERFACE --coverage)
    target_link_options(safe_cmpexec INTERFACE --coverage)
endif()

if(DTFUZZ)
    target_compile_options(safe_cmplib INTERFACE -fsanitize=address -fsanitize=undefined -fsanitize-recover=address,all --coverage -fdump-rtl-expand -fsanitize-coverage=trace-pc -g -O0 -fPIC -fno-omit-frame-pointer)
    target_compile_options(safe_cmpexec INTERFACE -fsanitize=address -fsanitize=undefined -fsanitize-recover=address,all -DENABLE_ASAN --coverage -fdump-rtl-expand -fsanitize-coverage=trace-pc -g -O0 -fPIC -fno-omit-frame-pointer)
    target_link_options(safe_cmplib INTERFACE -lasan -lubsan -static-libasan -static-libubsan -lgcov)
    target_link_options(safe_cmpexec INTERFACE -lasan -lubsan -static-libasan -static-libubsan -lgcov)
endif()

if(ASAN)
    target_compile_options(safe_cmplib INTERFACE -fsanitize=address -fsanitize=undefined -fsanitize-recover=address,all)
    target_compile_options(safe_cmpexec INTERFACE -fsanitize=address -fsanitize=undefined -fsanitize-recover=address,all -DENABLE_ASAN)
    target_link_options(safe_cmplib INTERFACE -lasan -lubsan -static-libasan -static-libubsan)
    target_link_options(safe_cmpexec INTERFACE -lasan -lubsan -static-libasan -static-libubsan)
endif()

if(TSAN)
    target_compile_options(safe_cmplib INTERFACE -fsanitize=thread -fno-omit-frame-pointer)
    target_link_options(safe_cmplib INTERFACE -static-libtsan -ltsan)
    target_compile_options(safe_cmpexec INTERFACE -fsanitize=thread -fno-omit-frame-pointer)
    target_link_options(safe_cmpexec INTERFACE -static-libtsan -ltsan)
endif()

if(TARGET checklib-undefined)
    MESSAGE(STATUS "checklib-undefined existed")
else()
    add_library(checklib-undefined INTERFACE)
    if(NOT (WIN32 OR TSAN OR ASAN))
        target_link_options(checklib-undefined INTERFACE -Wl,--no-undefined)
    endif()
endif()

set(CMAKE_CXX_STANDARD 17)
set(CMAKE_CXX_EXTENSIONS OFF)
set(CMAKE_CXX_STANDARD_REQUIRED ON)
set(CMAKE_SKIP_RPATH ON)
set(CMAKE_SKIP_BUILD_RPATH ON)
set(CMAKE_CXX_FLAGS "-Wno-error=deprecated-declarations -Wno-deprecated-declarations -Wno-dev")
