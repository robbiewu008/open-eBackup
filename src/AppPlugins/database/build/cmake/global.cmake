option(LLT "Compile in LLT mode" OFF)
option(ASAN "Compile in ASAN mode" OFF)
option(TSAN "Compile in TSAN mode" OFF)
option(DTFUZZ "Compile in DTFUZZ mode" OFF)

add_library(safe_cmplib INTERFACE)
MESSAGE("CMAKE:::${CMAKE_SYSTEM_NAME}")
if (CMAKE_SYSTEM_NAME MATCHES "Linux")
    target_compile_options(safe_cmplib INTERFACE -fPIC -pipe -fstack-protector-strong -s)
    target_link_options(safe_cmplib INTERFACE -fpie -Wl,-z,relro -Wl,-z,now -Wl,-z,noexecstack -pie)
    add_library(safe_cmpexec INTERFACE)
    target_compile_options(safe_cmpexec INTERFACE -fPIC -pipe -fstack-protector-strong -s)
    target_link_options(safe_cmpexec INTERFACE -fpie -Wl,-z,relro -Wl,-z,now -Wl,-z,noexecstack -pie)
    set(CMAKE_CXX_FLAGS "-Wno-error=deprecated-declarations -Wno-deprecated-declarations ")
elseif (CMAKE_SYSTEM_NAME MATCHES "AIX")
    MESSAGE("AIX compile.")
    option(AIX_COMPILE "Compile in AIX mode" ON)
    target_compile_options(safe_cmplib INTERFACE -fPIC -pipe -Wl,-b64 -shared)
    target_link_options(safe_cmplib INTERFACE -Wl,-bbigtoc)
    add_library(safe_cmpexec INTERFACE)
    target_compile_options(safe_cmpexec INTERFACE -fPIC -pipe -Wl,-b64 -shared)
    target_link_options(safe_cmpexec INTERFACE -fpie -Wl,-bbigtoc -pie)
    set(CMAKE_CXX_FLAGS   "${CMAKE_CXX_FLAGS} -maix64 -pthread")
else()
    target_compile_options(safe_cmplib INTERFACE -fPIC -pipe -fstack-protector-strong -s -DWIN32 -D__WINDOWS__)
    target_link_options(safe_cmplib INTERFACE -fpie -Wl,-z,relro -Wl,-z,now -Wl,-z,noexecstack -pie)
    add_library(safe_cmpexec INTERFACE)
    target_compile_options(safe_cmpexec INTERFACE -fPIC -pipe -fstack-protector-strong -s)
    target_link_options(safe_cmpexec INTERFACE -fpie -Wl,-z,relro -Wl,-z,now -Wl,-z,noexecstack -pie)
    set(CMAKE_CXX_FLAGS "-Wno-error=deprecated-declarations -Wno-deprecated-declarations ")
endif()

add_library(tcmalloc_cmpexec INTERFACE)
target_compile_options(tcmalloc_cmpexec INTERFACE -DENABLE_TCMALLOC)

if(CMAKE_BUILD_TYPE STREQUAL "Release")
    message(STATUS "Build release version")
    target_link_options(safe_cmplib INTERFACE -s)
    target_link_options(safe_cmpexec INTERFACE -s)
else()
    target_compile_options(safe_cmplib INTERFACE -g)
    target_link_options(safe_cmplib INTERFACE -g)
    target_compile_options(safe_cmpexec INTERFACE -g)
    target_link_options(safe_cmpexec INTERFACE -g)
endif()

if(LLT)
    target_compile_options(safe_cmplib INTERFACE --coverage)
    target_link_options(safe_cmplib INTERFACE --coverage)
    target_compile_options(safe_cmpexec INTERFACE --coverage)
    target_link_options(safe_cmpexec INTERFACE --coverage)
endif()

if(DTFUZZ)
    target_compile_options(safe_cmplib INTERFACE -fsanitize=address -fsanitize=undefined -fsanitize-recover=address,all --coverage -fdump-rtl-expand -fsanitize-coverage=trace-pc -g -O0 -fPIC -fno-omit-frame-pointer)
    target_compile_options(safe_cmpexec INTERFACE -fsanitize=address -fsanitize=undefined -fsanitize-recover=address,all -DENABLE_ASAN --coverage -fdump-rtl-expand -fsanitize-coverage=trace-pc -g -O0 -fPIC -fno-omit-frame-pointer)
    target_link_options(safe_cmplib INTERFACE -lasan -lubsan -static-libasan -static-libubsan -lgcov)
    target_link_options(safe_cmpexec INTERFACE -lasan -lubsan -static-libasan -static-libubsan -lgcov)
endif()

if(ASAN)
    target_compile_options(safe_cmplib INTERFACE -fsanitize=address -fsanitize=undefined -fsanitize-recover=address,all)
    target_compile_options(safe_cmpexec INTERFACE -fsanitize=address -fsanitize=undefined -fsanitize-recover=address,all -DENABLE_ASAN)
    target_link_options(safe_cmplib INTERFACE -lasan -lubsan -static-libasan -static-libubsan)
    target_link_options(safe_cmpexec INTERFACE -lasan -lubsan -static-libasan -static-libubsan)
endif()

if(TSAN)
    target_compile_options(safe_cmplib INTERFACE -fsanitize=thread -fno-omit-frame-pointer)
    target_link_options(safe_cmplib INTERFACE -static-libtsan -ltsan)
    target_compile_options(safe_cmpexec INTERFACE -fsanitize=thread -fno-omit-frame-pointer)
    target_link_options(safe_cmpexec INTERFACE -static-libtsan -ltsan)
endif()

add_library(checklib-undefined INTERFACE)
if(NOT (WIN32 OR TSAN OR ASAN))
    target_link_options(checklib-undefined INTERFACE -Wl,--no-undefined)
endif()

set(CMAKE_CXX_STANDARD 17)
set(CMAKE_CXX_EXTENSIONS OFF)
set(CMAKE_CXX_STANDARD_REQUIRED ON)
set(CMAKE_SKIP_RPATH ON)
set(CMAKE_SKIP_BUILD_RPATH ON)