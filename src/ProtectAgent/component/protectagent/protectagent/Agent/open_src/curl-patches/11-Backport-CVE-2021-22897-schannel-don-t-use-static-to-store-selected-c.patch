From 6fd854150f99222907705fc499bfb0a860310237 Mon Sep 17 00:00:00 2001
From: jiahuasheng <jiahuasheng@huawei.com>
Date: Wed, 26 May 2021 17:42:16 +0800
Subject: [PATCH] [Backport] schannel: don't use static to store selected
CVE: CVE-2021-22897
Reference: https://github.com/curl/curl/commit/bbb71507b7bab52002f9b1e0880bed6a32834511
---
 lib/vtls/schannel.c | 9 +++++----
 lib/vtls/schannel.h | 3 +++
 2 files changed, 8 insertions(+), 4 deletions(-)

diff --git a/lib/vtls/schannel.c b/lib/vtls/schannel.c
index 3e7f0bf..ff371e0 100644
--- a/lib/vtls/schannel.c
+++ b/lib/vtls/schannel.c
@@ -323,12 +323,12 @@ get_alg_id_by_name(char *name)
 }
 
 static CURLcode
-set_ssl_ciphers(SCHANNEL_CRED *schannel_cred, char *ciphers)
+set_ssl_ciphers(SCHANNEL_CRED *schannel_cred, char *ciphers,
+                int *algIds)
 {
   char *startCur = ciphers;
   int algCount = 0;
-  static ALG_ID algIds[45]; /*There are 45 listed in the MS headers*/
-  while(startCur && (0 != *startCur) && (algCount < 45)) {
+  while(startCur && (0 != *startCur) && (algCount < NUMOF_CIPHERS)) {
     long alg = strtol(startCur, 0, 0);
     if(!alg)
       alg = get_alg_id_by_name(startCur);
@@ -579,7 +579,8 @@ schannel_connect_step1(struct connectdata *conn, int sockindex)
     }
 
     if(SSL_CONN_CONFIG(cipher_list)) {
-      result = set_ssl_ciphers(&schannel_cred, SSL_CONN_CONFIG(cipher_list));
+      result = set_ssl_ciphers(&schannel_cred, SSL_CONN_CONFIG(cipher_list),
+                               BACKEND->algIds);
       if(CURLE_OK != result) {
         failf(data, "Unable to set ciphers to passed via SSL_CONN_CONFIG");
         return result;
diff --git a/lib/vtls/schannel.h b/lib/vtls/schannel.h
index ee8d7d4..12e7c7d 100644
--- a/lib/vtls/schannel.h
+++ b/lib/vtls/schannel.h
@@ -70,6 +70,8 @@ CURLcode Curl_verify_certificate(struct connectdata *conn, int sockindex);
 #endif
 #endif
 
+#define NUMOF_CIPHERS 45 /* There are 45 listed in the MS headers */
+
 struct curl_schannel_cred {
   CredHandle cred_handle;
   TimeStamp time_stamp;
@@ -101,6 +103,7 @@ struct ssl_backend_data {
 #ifdef HAS_MANUAL_VERIFY_API
   bool use_manual_cred_validation; /* true if manual cred validation is used */
 #endif
+  ALG_ID algIds[NUMOF_CIPHERS];
 };
 #endif /* EXPOSE_SCHANNEL_INTERNAL_STRUCTS */
 
-- 
2.1.4

