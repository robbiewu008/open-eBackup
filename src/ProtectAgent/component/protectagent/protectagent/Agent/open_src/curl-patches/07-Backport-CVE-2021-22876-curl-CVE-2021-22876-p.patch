From f3080db2c494f41909d7460b2e780614fbc1d3f2 Mon Sep 17 00:00:00 2001
From: <niujiaming@huawei.com>
Date: Wed, 7 Apr 2021 15:59:47 +0800
Subject: [PATCH] =?UTF-8?q?[Backport]=E4=BF=AE=E5=A4=8Dcurl=E5=BC=80?=
CVE:CVE-2021-22876
Reference:https://github.com/curl/curl/commit/7214288898f5625a6cc196e22a74232eada7861c
---
 lib/transfer.c          | 25 +++++++++++++++++++++++--
 tests/data/Makefile.inc |  2 +-
 2 files changed, 24 insertions(+), 3 deletions(-)

diff --git a/lib/transfer.c b/lib/transfer.c
index 44104ab..452fc58 100644
--- a/lib/transfer.c
+++ b/lib/transfer.c
@@ -1582,6 +1582,9 @@ CURLcode Curl_follow(struct Curl_easy *data,
       data->set.followlocation++; /* count location-followers */
 
       if(data->set.http_auto_referer) {
+        CURLU *u;
+        char *referer = NULL;
+
         /* We are asked to automatically set the previous URL as the referer
            when we get the next URL. We pick the ->url field, which may or may
            not be 100% correct */
@@ -1591,9 +1594,27 @@ CURLcode Curl_follow(struct Curl_easy *data,
           data->change.referer_alloc = FALSE;
         }
 
-        data->change.referer = strdup(data->change.url);
-        if(!data->change.referer)
+        /* Make a copy of the URL without crenditals and fragment */
+        u = curl_url();
+        if(!u)
+          return CURLE_OUT_OF_MEMORY;
+        
+        uc = curl_url_set(u, CURLUPART_URL, data->change.url, 0);
+        if(!uc)
+          uc = curl_url_set(u, CURLUPART_FRAGMENT, NULL, 0);
+        if(!uc)
+          uc = curl_url_set(u, CURLUPART_USER, NULL, 0);
+        if(!uc)
+          uc = curl_url_set(u, CURLUPART_PASSWORD, NULL, 0);
+        if(!uc)
+          uc = curl_url_get(u, CURLUPART_URL, &referer, 0);
+        
+        curl_url_cleanup(u);
+
+        if(uc || referer == NULL)
           return CURLE_OUT_OF_MEMORY;
+        
+        data->change.referer = referer;
         data->change.referer_alloc = TRUE; /* yes, free this later */
       }
     }
diff --git a/tests/data/Makefile.inc b/tests/data/Makefile.inc
index ef9252b..5baed31 100644
--- a/tests/data/Makefile.inc
+++ b/tests/data/Makefile.inc
@@ -221,7 +221,7 @@ test2064 test2065 test2066 test2067 test2068 test2069 \
 test2064 test2065 test2066 test2067 test2068 test2069 test2070 \
          test2071 test2072 test2073 test2074 test2075 test2076 test2077 \
 test2078 \
-test2080 \
+test2080 test2081 \
 test2100 \
 \
 test3000 test3001 \
-- 
2.1.4

